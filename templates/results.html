<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - WPE Crash Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .confidence-high { color: #28a745; }
        .confidence-medium { color: #ffc107; }
        .confidence-low { color: #dc3545; }
        .result-section { margin-bottom: 30px; }
        .log-entry { 
            background: #f8f9fa; 
            padding: 10px; 
            border-left: 4px solid #007bff; 
            margin: 5px 0; 
            font-family: monospace;
            font-size: 0.9rem;
        }
        .signal-received {
            background-color: #ffcccb !important;
            color: #d32f2f !important;
            font-weight: bold !important;
            border: 1px solid #d32f2f !important;
            border-radius: 3px !important;
            padding: 2px 4px !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-bug"></i> WPE Crash Analyzer
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                <a class="nav-link" href="{{ url_for('upload_logs') }}">New Analysis</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4><i class="fas fa-chart-line"></i> Crash Analysis Results</h4>
                        <span class="badge bg-success">{{ result.phase }}</span>
                    </div>
                    <div class="card-body">
                        <!-- Status and Confidence -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                {% if result.no_crash_found or result.status == 'No crash found' %}
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Status:</strong> No Crash Detected
                                </div>
                                {% else %}
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check-circle"></i> 
                                    <strong>Status:</strong> {{ result.status.title() }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {% if result.no_crash_found or result.status == 'No crash found' %}
                                <div class="alert alert-secondary" role="alert">
                                    <i class="fas fa-info"></i> 
                                    <strong>Analysis:</strong> Normal Operations
                                </div>
                                {% else %}
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-thermometer-half"></i> 
                                    <strong>Confidence:</strong> 
                                    <span class="confidence-{{ result.confidence.lower() }}">
                                        {{ result.confidence }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- No Crash Found Message -->
                        {% if result.no_crash_found or result.status == 'No crash found' %}
                        <div class="alert alert-info" role="alert">
                            <h5><i class="fas fa-info-circle"></i> Analysis Results</h5>
                            <p><strong>{{ result.message or 'No genuine crash detected in the uploaded log files.' }}</strong></p>
                            <p>The uploaded logs appear to contain normal system operations rather than crash evidence. This could mean:</p>
                            <ul>
                                <li>The logs are from a period when the system was functioning normally</li>
                                <li>The crash occurred outside the timeframe covered by these logs</li>
                                <li>The crash logs may be in a different location or log file</li>
                            </ul>
                            
                            {% if result.ownership_analysis and result.ownership_analysis.recommendation %}
                            <div class="mt-3">
                                <strong>Recommendation:</strong> {{ result.ownership_analysis.recommendation }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Device Information -->
                        <div class="result-section">
                            <h5><i class="fas fa-microchip"></i> Device Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>MAC Address</h6>
                                            <p class="text-monospace">{{ result.device_info.mac_address }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Image Version</h6>
                                            <p class="text-monospace">{{ result.device_info.image_version }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Crash Details - Only show if crash was found -->
                        {% if not result.no_crash_found and result.status != 'No crash found' %}
                        <div class="result-section">
                            <h5><i class="fas fa-exclamation-triangle"></i> Crash Details</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Crashed Process(es)</h6>
                                            {% for process in result.crash_details.crashed_process %}
                                                <span class="badge bg-danger me-1">{{ process }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Signal</h6>
                                            <span class="badge bg-warning text-dark">{{ result.crash_details.signal }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Crash Timestamp</h6>
                                            <p class="text-monospace">{{ result.crash_details.timestamp }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if result.crash_details.crash_context %}
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Additional Crash Context</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    {% for key, value in result.crash_details.crash_context.items() %}
                                                    <tr>
                                                        <td><strong>{{ key.replace('_', ' ').title() }}</strong></td>
                                                        <td class="text-monospace">{{ value }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Phase 2: Ownership Analysis -->
                        {% if result.ownership_analysis %}
                        <div class="result-section">
                            <h5><i class="fas fa-balance-scale"></i> Phase 2: Thunder vs Plugin Responsibility</h5>
                            
                            <!-- Ownership Conclusion -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h6>Primary Ownership</h6>
                                            <h4 class="text-primary">{{ result.ownership_analysis.get('primary_ownership', 'Unknown') }}</h4>
                                            {% if "Plugin" in result.ownership_analysis.get('primary_ownership', '') %}
                                                <span class="badge bg-warning">Thunder Plugin</span>
                                            {% elif "Core" in result.ownership_analysis.get('primary_ownership', '') %}
                                                <span class="badge bg-danger">Thunder Core</span>
                                            {% elif "Comrpc" in result.ownership_analysis.get('primary_ownership', '') %}
                                                <span class="badge bg-info">COMRPC Layer</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Framework</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h6>Ownership Confidence</h6>
                                            <h4 class="confidence-{{ result.ownership_analysis.get('confidence', 'low').lower() }}">
                                                {{ result.ownership_analysis.get('confidence', 'Unknown') }}
                                            </h4>
                                            {% if result.ownership_analysis.get('confidence_adjustment') %}
                                                <small class="text-muted">{{ result.ownership_analysis.get('confidence_adjustment') }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h6>Recommendation</h6>
                                            <p class="text-success mb-0">{{ result.ownership_analysis.get('recommendation', 'No recommendation available') }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hypothesis -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="fas fa-lightbulb"></i> Ownership Hypothesis</h6>
                            {% if result.ownership_analysis.get('enhanced_hypothesis') %}
                                <div class="alert alert-info mb-3">
                                    <h6>Enhanced Analysis with Multi-Log Context:</h6>
                                    <p class="mb-0">{{ result.ownership_analysis.get('enhanced_hypothesis') }}</p>
                                </div>
                            {% else %}
                                <p class="mb-0">{{ result.ownership_analysis.get('hypothesis', 'No hypothesis available') }}</p>
                            {% endif %}
                            
                            {% if result.ownership_analysis.get('analysis_note') %}
                                <div class="alert alert-warning mt-3 mb-0">
                                    <small><i class="fas fa-info-circle"></i> {{ result.ownership_analysis.get('analysis_note') }}</small>
                                </div>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-search"></i> Supporting Evidence</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if result.ownership_analysis.get('evidence_summary') %}
                                                <div class="table-responsive">
                                                    <table class="table table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>Component</th>
                                                                <th>Evidence Strength</th>
                                                                <th>Key Evidence Patterns</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for evidence in result.ownership_analysis.get('evidence_summary', []) %}
                                                            <tr>
                                                                <td><strong>{{ evidence.get('category', 'Unknown') }}</strong></td>
                                                                <td>
                                                                    {% if evidence.get('high_confidence_count') is defined %}
                                                                        <span class="badge bg-danger">High: {{ evidence.get('high_confidence_count', 0) }}</span>
                                                                        <span class="badge bg-warning">Med: {{ evidence.get('medium_confidence_count', 0) }}</span>
                                                                        <span class="badge bg-secondary">Low: {{ evidence.get('low_confidence_count', 0) }}</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">{{ evidence.get('evidence_count', evidence.get('score', 0)) }}</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% for pattern in evidence.get('key_patterns', []) %}
                                                                        <span class="badge bg-light text-dark me-1">{{ pattern }}</span>
                                                                    {% endfor %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning" role="alert">
                                                    No clear ownership evidence patterns found in logs
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-chart-pie"></i> Thunder vs Plugin Evidence Analysis</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if result.ownership_analysis.get('evidence_summary') %}
                                                {% for evidence_item in result.ownership_analysis.get('evidence_summary', []) %}
                                                    <div class="mb-3">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <span class="font-weight-bold">{{ evidence_item.category }}</span>
                                                            <div>
                                                                {% if evidence_item.get('high_confidence_count', 0) > 0 %}
                                                                    <span class="badge badge-success">High: {{ evidence_item.get('high_confidence_count', 0) }}</span>
                                                                {% endif %}
                                                                {% if evidence_item.get('medium_confidence_count', 0) > 0 %}
                                                                    <span class="badge badge-warning">Medium: {{ evidence_item.get('medium_confidence_count', 0) }}</span>
                                                                {% endif %}
                                                                {% if evidence_item.get('low_confidence_count', 0) > 0 %}
                                                                    <span class="badge badge-light">Low: {{ evidence_item.get('low_confidence_count', 0) }}</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Evidence strength indicator -->
                                                        {% set high_count = evidence_item.get('high_confidence_count', 0) %}
                                                        {% set medium_count = evidence_item.get('medium_confidence_count', 0) %}
                                                        {% set low_count = evidence_item.get('low_confidence_count', 0) %}
                                                        {% set total_evidence = high_count + medium_count + low_count %}
                                                        {% set strength_percentage = ((high_count * 3 + medium_count) * 100) / (total_evidence * 3) if total_evidence > 0 else 0 %}
                                                        
                                                        <div class="progress mb-2" style="height: 8px;">
                                                            {% if "plugin" in evidence_item.get('category', '').lower() %}
                                                                <div class="progress-bar bg-warning" style="width: {{ strength_percentage }}%"></div>
                                                            {% elif "core" in evidence_item.get('category', '').lower() %}
                                                                <div class="progress-bar bg-danger" style="width: {{ strength_percentage }}%"></div>
                                                            {% elif "comrpc" in evidence_item.get('category', '').lower() %}
                                                                <div class="progress-bar bg-info" style="width: {{ strength_percentage }}%"></div>
                                                            {% else %}
                                                                <div class="progress-bar bg-secondary" style="width: {{ strength_percentage }}%"></div>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <!-- Key patterns -->
                                                        {% if evidence_item.get('key_patterns') %}
                                                            <div class="small text-muted">
                                                                <strong>Key patterns:</strong> 
                                                                {% for pattern in evidence_item.get('key_patterns', [])[:2] %}
                                                                    {{ pattern }}{% if not loop.last %}, {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-muted">No clear evidence patterns identified</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Contextual Insights from Multi-Log Analysis -->
                        {% if result.ownership_analysis.get('contextual_insights') %}
                        <div class="result-section">
                            <h5><i class="fas fa-search-plus"></i> Multi-Log Contextual Insights</h5>
                            <div class="row">
                                <div class="col-12">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Additional Evidence from Log Directory</h6>
                                        </div>
                                        <div class="card-body">
                                            {% for insight in result.ownership_analysis.contextual_insights %}
                                                <div class="alert alert-warning mb-2" role="alert">
                                                    <i class="fas fa-info-circle"></i> {{ insight }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Multi-Log Crash Correlation Analysis -->
                        {% if result.ownership_analysis.get('multi_log_analysis') %}
                        {% set multi_analysis = result.ownership_analysis.multi_log_analysis %}
                        <div class="result-section">
                            <h5><i class="fas fa-project-diagram"></i> Multi-Log Crash Correlation Analysis</h5>
                            
                            {% if multi_analysis.wpe_framework_crash %}
                            <!-- Main Crash Information -->
                            <div class="alert alert-danger mb-4">
                                <h6><i class="fas fa-exclamation-triangle"></i> WPEFramework Crash Detected</h6>
                                <p class="mb-1"><strong>Crash Type:</strong> {{ multi_analysis.wpe_framework_crash.description }}</p>
                                <p class="mb-1"><strong>Timestamp:</strong> {{ multi_analysis.wpe_framework_crash.timestamp }}</p>
                                <p class="mb-1"><strong>Source Log:</strong> {{ multi_analysis.wpe_framework_crash.source_file }}</p>
                                <p class="mb-0"><strong>Details:</strong> <code>{{ multi_analysis.wpe_framework_crash.event_text }}</code></p>
                            </div>
                            
                            <!-- Crash Correlation Summary -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center border-info">
                                        <div class="card-body">
                                            <h4 class="text-info">{{ multi_analysis.summary.related_events_count }}</h4>
                                            <p class="mb-0">Related Events</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-warning">
                                        <div class="card-body">
                                            <h4 class="text-warning">{{ multi_analysis.summary.concurrent_events }}</h4>
                                            <p class="mb-0">Concurrent Events</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-primary">
                                        <div class="card-body">
                                            <h4 class="text-primary">{{ multi_analysis.summary.preceding_events }}</h4>
                                            <p class="mb-0">Preceding Events</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-secondary">
                                        <div class="card-body">
                                            <h4 class="text-secondary">{{ multi_analysis.summary.following_events }}</h4>
                                            <p class="mb-0">Following Events</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Crash Timeline -->
                            {% if multi_analysis.timeline_analysis %}
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6><i class="fas fa-clock"></i> Crash Timeline</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Timestamp</th>
                                                    <th>Source Log</th>
                                                    <th>Event Type</th>
                                                    <th>Description</th>
                                                    <th>Details</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for event in multi_analysis.timeline_analysis[:10] %}
                                                <tr>
                                                    <td class="text-nowrap">{{ event.timestamp }}</td>
                                                    <td>{{ event.source }}</td>
                                                    <td>
                                                        <span class="badge {% if event.event_type == 'MAIN_CRASH' %}bg-danger{% else %}bg-warning{% endif %}">
                                                            {{ event.event_type }}
                                                        </span>
                                                    </td>
                                                    <td>{{ event.description }}</td>
                                                    <td><code class="small">{{ event.details[:100] }}{% if event.details|length > 100 %}...{% endif %}</code></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Related Events in Other Logs -->
                            {% if multi_analysis.related_events %}
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6><i class="fas fa-link"></i> Related Events in Other Logs During Crash</h6>
                                </div>
                                <div class="card-body">
                                    <div class="accordion" id="relatedEventsAccordion">
                                        {% for event in multi_analysis.related_events[:10] %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                                    <strong>{{ event.source_file }}</strong> - {{ event.description }} ({{ event.timestamp }})
                                                </button>
                                            </h2>
                                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#relatedEventsAccordion">
                                                <div class="accordion-body">
                                                    <code>{{ event.event_text }}</code>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% else %}
                            <!-- No WPEFramework Crash Found -->
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No WPEFramework crash detected in the uploaded logs. 
                                Performed standard ownership analysis on available crash data.
                            </div>
                            {% endif %}
                            
                            <!-- Related Events Summary -->
                            {% if multi_analysis.related_events %}
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-link"></i> Related Events Summary</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>{{ multi_analysis.related_events|length }} related events</strong> found in other logs during the crash timeframe.</p>
                                    <small class="text-muted">Expand the "Related Events in Other Logs During Crash" section above for details.</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Phase 1: Crash Context -->
                        <div class="result-section">
                            <h5><i class="fas fa-file-alt"></i> Crash Context (Â±10 lines around signal)</h5>
                            {% if result.crash_details.last_meaningful_logs %}
                                <div class="card">
                                    <div class="card-body">
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.85rem; white-space: pre-wrap; overflow-x: auto;">{% for log_entry in result.crash_details.last_meaningful_logs %}{% if "Signal received" in log_entry %}<span class="signal-received">{{ log_entry }}</span>{% elif " >>> " in log_entry %}<span style="background-color: #ffeb3b; color: #d32f2f; font-weight: bold;">{{ log_entry }}</span>{% else %}<span style="color: #333;">{{ log_entry }}</span>{% endif %}
{% endfor %}</div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> <span class="signal-received">Signal received</span> lines indicate the crash point. Lines marked with " >>> " indicate additional context.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    No meaningful log entries found around the crash signal
                                </div>
                            {% endif %}
                        </div>

                        <!-- Summary -->
                        <div class="result-section">
                            <h5><i class="fas fa-clipboard-list"></i> Phase 1 Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr>
                                            <td><strong>Device MAC</strong></td>
                                            <td>{{ result.device_info.mac_address }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Image Version</strong></td>
                                            <td>{{ result.device_info.image_version }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Crashed Process</strong></td>
                                            <td>{{ ', '.join(result.crash_details.crashed_process) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Signal</strong></td>
                                            <td>{{ result.crash_details.signal }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Timestamp</strong></td>
                                            <td>{{ result.crash_details.timestamp }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Analysis Confidence</strong></td>
                                            <td>
                                                <span class="confidence-{{ result.confidence.lower() }}">
                                                    {{ result.confidence }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Phase 3: Stack Trace Analysis -->
                        {% if result.stacktrace_analysis %}
                        <div class="result-section">
                            <h5><i class="fas fa-layer-group"></i> Phase 3: Stack Trace Analysis - Confirmed Ownership</h5>
                            
                            <!-- MAC Address Validation -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card border-{% if result.stacktrace_analysis.mac_validation.consistent %}success{% else %}danger{% endif %}">
                                        <div class="card-header">
                                            <h6>
                                                <i class="fas fa-{% if result.stacktrace_analysis.mac_validation.consistent %}check-circle text-success{% else %}times-circle text-danger{% endif %}"></i>
                                                MAC Address Validation
                                                <span class="badge bg-{% if result.stacktrace_analysis.mac_validation.consistent %}success{% else %}danger{% endif %}">
                                                    {{ result.stacktrace_analysis.mac_validation.validation_status }}
                                                </span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if result.stacktrace_analysis.mac_validation.consistent %}
                                                <div class="alert alert-success">
                                                    <i class="fas fa-shield-alt"></i> MAC addresses are consistent between core logs and stack trace dump file.
                                                </div>
                                            {% else %}
                                                <div class="alert alert-danger">
                                                    <i class="fas fa-exclamation-triangle"></i> Warning: MAC address mismatch detected between logs and stack trace.
                                                </div>
                                            {% endif %}
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Stack Trace MAC Addresses:</h6>
                                                    {% for mac in result.stacktrace_analysis.mac_validation.stacktrace_macs %}
                                                        <span class="badge bg-info me-1">{{ mac }}</span>
                                                    {% else %}
                                                        <span class="text-muted">None found</span>
                                                    {% endfor %}
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Core Log MAC Addresses:</h6>
                                                    {% for mac in result.stacktrace_analysis.mac_validation.core_log_macs %}
                                                        <span class="badge bg-primary me-1">{{ mac }}</span>
                                                    {% else %}
                                                        <span class="text-muted">None found</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Confirmed Ownership -->
                            {% if result.stacktrace_analysis.confirmed_ownership %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h6>Confirmed Ownership</h6>
                                            <h4 class="text-success">{{ result.stacktrace_analysis.confirmed_ownership.confirmed_ownership }}</h4>
                                            <span class="badge bg-success">{{ result.stacktrace_analysis.confirmed_ownership.phase }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h6>Phase 3 Confidence</h6>
                                            <h4 class="confidence-{{ result.stacktrace_analysis.confirmed_ownership.confidence_level.lower() }}">
                                                {{ result.stacktrace_analysis.confirmed_ownership.confidence_level }}
                                            </h4>
                                            <small class="text-muted">Based on call stack analysis</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h6>Evidence Summary</h6>
                                            <p class="mb-1"><strong>Thunder Core:</strong> {{ result.stacktrace_analysis.confirmed_ownership.evidence_summary.thunder_core_frames }} frames</p>
                                            <p class="mb-1"><strong>Plugin:</strong> {{ result.stacktrace_analysis.confirmed_ownership.evidence_summary.thunder_plugin_frames }} frames</p>
                                            <p class="mb-0"><strong>Boundaries:</strong> {{ result.stacktrace_analysis.confirmed_ownership.evidence_summary.boundary_crossings }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Phase 3 Override Information -->
                            {% if result.ownership_analysis and result.ownership_analysis.get('phase3_override') %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-arrow-up"></i> Phase 3 Override Applied</h6>
                                        <p><strong>Phase 2 Hypothesis:</strong> {{ result.ownership_analysis.phase3_override.phase2_hypothesis }}</p>
                                        <p><strong>Phase 3 Confirmed:</strong> {{ result.ownership_analysis.phase3_override.phase3_confirmed }}</p>
                                        <p class="mb-0"><strong>Confidence:</strong> {{ result.ownership_analysis.phase3_override.confidence_upgrade }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Stack Trace Reasoning -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6><i class="fas fa-brain"></i> Confirmed Ownership Reasoning</h6>
                                            <ul class="mb-0">
                                                {% for reason in result.stacktrace_analysis.confirmed_ownership.reasoning %}
                                                    <li>{{ reason }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Call Stack Analysis -->
                            {% if result.stacktrace_analysis.call_stack_analysis %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-list-ol"></i> Call Stack Analysis ({{ result.stacktrace_analysis.call_stack_analysis|length }} frames)</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table table-sm table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Frame</th>
                                                            <th>Address</th>
                                                            <th>Function</th>
                                                            <th>Source File</th>
                                                            <th>Line</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for frame in result.stacktrace_analysis.call_stack_analysis %}
                                                        <tr>
                                                            <td><span class="badge bg-secondary">#{{ frame.frame }}</span></td>
                                                            <td><code>{{ frame.address }}</code></td>
                                                            <td>
                                                                <code>{{ frame.function }}</code>
                                                                {% if frame.frame == 0 %}
                                                                    <span class="badge bg-danger ms-2">CRASH POINT</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ frame.source_file }}</td>
                                                            <td>{{ frame.line_number }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Crash Location Details -->
                            {% if result.stacktrace_analysis.crash_location %}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card border-danger">
                                        <div class="card-header">
                                            <h6><i class="fas fa-crosshairs"></i> Crash Location</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Function:</strong> <code>{{ result.stacktrace_analysis.crash_location.crash_function }}</code></p>
                                            <p><strong>Source File:</strong> {{ result.stacktrace_analysis.crash_location.source_file }}</p>
                                            <p><strong>Line Number:</strong> {{ result.stacktrace_analysis.crash_location.line_number }}</p>
                                            <p><strong>Address:</strong> <code>{{ result.stacktrace_analysis.crash_location.assembly_address }}</code></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-header">
                                            <h6><i class="fas fa-cog"></i> Enhanced Thread Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Thread ID:</strong> {{ result.stacktrace_analysis.thread_analysis.thread_id }}</p>
                                            <p><strong>Thread Name:</strong> {{ result.stacktrace_analysis.thread_analysis.thread_name }}</p>
                                            <p><strong>Thread Type:</strong> {{ result.stacktrace_analysis.thread_analysis.thread_type }}</p>
                                            <p><strong>Thread State:</strong> {{ result.stacktrace_analysis.thread_analysis.thread_state }}</p>
                                            <p><strong>Multiple Threads:</strong> {{ "Yes" if result.stacktrace_analysis.thread_analysis.multiple_threads else "No" }}</p>
                                            {% if result.stacktrace_analysis.thread_analysis.multiple_threads %}
                                                <p><strong>Total Threads:</strong> {{ result.stacktrace_analysis.thread_analysis.thread_details|length }}</p>
                                            {% endif %}
                                            {% if result.stacktrace_analysis.thread_analysis.crash_thread_info %}
                                                <div class="alert alert-danger mt-2">
                                                    <small><strong>Crashed Thread:</strong> {{ result.stacktrace_analysis.thread_analysis.crash_thread_info.id }} ({{ result.stacktrace_analysis.thread_analysis.crash_thread_info.name }})</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Symbol Resolution -->
                            {% if result.stacktrace_analysis.symbol_resolution %}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fas fa-code"></i> Symbol Resolution & Boundary Analysis</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <h6>Thunder Core Symbols</h6>
                                                    {% for symbol in result.stacktrace_analysis.symbol_resolution.thunder_core_symbols %}
                                                        <div class="mb-2">
                                                            <span class="badge bg-primary">Frame #{{ symbol.frame }}</span>
                                                            <br><code style="font-size: 0.8em;">{{ symbol.function }}</code>
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted">No Thunder Core symbols found</p>
                                                    {% endfor %}
                                                </div>
                                                <div class="col-md-4">
                                                    <h6>Plugin Symbols</h6>
                                                    {% for symbol in result.stacktrace_analysis.symbol_resolution.thunder_plugin_symbols %}
                                                        <div class="mb-2">
                                                            <span class="badge bg-warning">Frame #{{ symbol.frame }}</span>
                                                            <br><code style="font-size: 0.8em;">{{ symbol.function }}</code>
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted">No Plugin symbols found</p>
                                                    {% endfor %}
                                                </div>
                                                <div class="col-md-4">
                                                    <h6>Boundary Crossings</h6>
                                                    {% for boundary in result.stacktrace_analysis.symbol_resolution.boundary_crossings %}
                                                        <div class="mb-2">
                                                            <span class="badge bg-info">{{ boundary.from_ownership }} â {{ boundary.to_ownership }}</span>
                                                            <br><small>Frame {{ boundary.from_frame }} â {{ boundary.to_frame }}</small>
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted">No boundary crossings detected</p>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Actions -->
                        <div class="d-flex gap-2 mt-4">
                            <a href="{{ url_for('upload_logs') }}" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Analyze Another Crash
                            </a>
                            <button class="btn btn-secondary" onclick="downloadReport()">
                                <i class="fas fa-download"></i> Download Report
                            </button>
                            <button class="btn btn-info" onclick="copyToClipboard()">
                                <i class="fas fa-copy"></i> Copy Summary
                            </button>
                        </div>

                        <!-- Next Phase Info -->
                        <div class="alert alert-info mt-4" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>Analysis Complete:</strong> 
                            {% if result.stacktrace_analysis %}
                                Phase 3 stack trace analysis completed with confirmed ownership determination.
                            {% elif result.ownership_analysis.get('multi_log_analysis') %}
                                Enhanced Phase 2 multi-log crash correlation analysis completed focusing on the WPEFramework crash and related events.
                            {% else %}
                                Phase 2 ownership analysis completed. For deeper insights, try uploading additional log files with multi-log analysis enabled.
                            {% endif %}
                            <br>
                            {% if not result.stacktrace_analysis %}
                                <strong>Next Steps:</strong> Upload stacktrace-content.txt with Phase 3 enabled for confirmed ownership determination via call stack analysis.
                            {% else %}
                                <strong>Ownership Confirmed:</strong> Stack trace analysis provides definitive ownership determination with high confidence.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function downloadReport() {
            const reportData = {{ result|tojson }};
            const blob = new Blob([JSON.stringify(reportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crash_analysis_report_' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const summary = `WPE Framework Crash Analysis - Phase 1
Device MAC: {{ result.device_info.mac_address }}
Image Version: {{ result.device_info.image_version }}
Crashed Process: {{ ', '.join(result.crash_details.crashed_process) }}
Signal: {{ result.crash_details.signal }}
Timestamp: {{ result.crash_details.timestamp }}
Confidence: {{ result.confidence }}`;

            navigator.clipboard.writeText(summary).then(() => {
                alert('Summary copied to clipboard!');
            });
        }
    </script>
</body>
</html>
